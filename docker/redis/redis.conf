# Redis Configuration for Escalation League
# Performance and memory optimization

# Memory Management
maxmemory 256mb
maxmemory-policy allkeys-lru  # Evict least recently used keys when memory limit reached

# Active Defragmentation (Redis 4.0+)
activedefrag yes              # Enable automatic memory defragmentation
active-defrag-threshold-lower 10   # Start defrag when fragmentation > 10%
active-defrag-threshold-upper 100  # Max effort when fragmentation > 100%
active-defrag-cycle-min 5          # Minimum CPU effort %
active-defrag-cycle-max 75         # Maximum CPU effort %

# Persistence (for session data)
save 900 1                    # Save after 900s if 1 key changed
save 300 10                   # Save after 300s if 10 keys changed
save 60 10000                 # Save after 60s if 10000 keys changed
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes

# Append Only File (for data durability)
appendonly yes
appendfsync everysec          # Fsync every second (good balance)
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Slow Log (for debugging)
slowlog-log-slower-than 10000  # Log queries slower than 10ms
slowlog-max-len 128           # Keep last 128 slow queries

# Client Output Buffer Limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60  # Important for Socket.IO

# TCP Settings
tcp-backlog 511
timeout 300                   # Close idle connections after 5 min
tcp-keepalive 300            # Send TCP keepalives every 5 min

# Lazy Freeing (async deletion)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
